<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Move Motorcycles â€“ Daily Route Planner</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- Marker Clustering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Export -->
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{ --navy:#040C34; --gold:#A08C59; }
    html,body{height:100%;margin:0} #map{height:100%}

    .toolbar{
      position:fixed;z-index:1000;top:10px;left:50%;transform:translateX(-50%);
      background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.12);
      display:flex;gap:8px;align-items:center;padding:8px 10px;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;flex-wrap:wrap
    }
    .toolbar select,.toolbar button,.toolbar input{height:36px;border-radius:10px;border:1px solid #e5e7eb;padding:0 10px;font-weight:600}
    .toolbar button{background:var(--gold);color:#111;border:none;cursor:pointer}
    .toolbar button.secondary{background:#fff;color:#111;border:1px solid #d1d5db}
    .toolbar label{ font-size:12px; color:#374151; margin-right:4px; }
    .toolbar .divider{width:1px;height:24px;background:#e5e7eb;margin:0 6px;border-radius:1px}

    .panel{
      position:fixed;right:10px;top:70px;bottom:10px;width:420px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:900;overflow:auto;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif
    }
    .panel h3{margin:14px 14px 6px;font-size:16px;color:var(--navy)}
    .panel .routeCard{margin:10px 12px;padding:10px;border:1px solid #e5e7eb;border-radius:12px}
    .panel .routeCard header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-weight:700;gap:6px}
    .panel .meta{font-size:12px;color:#374151}
    .panel .jobs{list-style:none;margin:8px 0 0;padding:0;min-height:12px}
    .panel .jobs li{display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px dashed #e5e7eb;border-radius:10px;margin-bottom:6px;background:#fafafa;justify-content:space-between}
    .panel .jobs li[draggable="true"]{cursor:grab}
    .panel .jobs.dragover{outline:2px dashed var(--gold);background:#fff}
    .badge{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb}
    .lite{font-size:12px;color:#6b7280}
    .chip.dot{width:12px;height:12px;border-radius:999px;display:inline-block;vertical-align:middle;margin-right:6px;border:1px solid rgba(0,0,0,.12)}
    .mm-pin{width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;font:bold 11px/1 system-ui;color:#fff}

    /* Fixed diagonal watermark, 0.25 opacity, under vectors */
    .watermark{
      position:fixed;inset:0;pointer-events:none;z-index:200;opacity:.25;
      background-image:repeating-linear-gradient(-30deg,rgba(4,12,52,.08) 0,rgba(4,12,52,.08) 2px,transparent 2px,transparent 140px),
                       repeating-linear-gradient(-30deg,transparent 0,transparent 140px,rgba(4,12,52,.08) 140px,rgba(4,12,52,.08) 142px)
    }
    .watermark::before{
      content:"MOVE MOTORCYCLES MOVE MOTORCYCLES MOVE MOTORCYCLES";
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.4em;font-size:40px;color:#040C34;opacity:.12;transform:rotate(-20deg)
    }

    .leaflet-routing-container{display:none}
    .leaflet-routing-line{stroke:#040C34!important;stroke-width:3px!important}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="watermark" aria-hidden="true"></div>

  <div class="toolbar">
    <label for="day">Date:</label>
    <input id="day" type="date" />
    <div class="divider"></div>

    <label for="start">Start time:</label>
    <input id="start" type="time" value="08:00" />
    <div class="divider"></div>

    <label>Status:</label>
    <select id="statusFilter">
      <option value="all">All</option>
      <option>Pick up Request</option>
      <option>Booking received</option>
      <option>Driver assigned for collection</option>
      <option>Collected</option>
      <option>Driver assigned for delivery</option>
      <option>Delivered</option>
      <option>Review</option>
      <option>Review not requested</option>
    </select>

    <div class="divider"></div>
    <label for="depotPc">Depot:</label>
    <input id="depotPc" value="OX447RW" />

    <button id="importJsonBtn" class="secondary">Import JSON</button>
    <button id="importCsvBtn" class="secondary">Import CSV</button>
    <input id="csvUpload" type="file" accept=".csv" style="display:none" />

    <button id="exportBtn">Export day (GeoJSON)</button>
  </div>

  <aside class="panel" id="panel"></aside>

<script>
(function(){
  // Drivers (with your home postcodes)
  const drivers = [
    { id:"mark",  name:"Mark",  color:'#1f77b4', homePostcode:'WS137JY' },
    { id:"keith", name:"Keith", color:'#ff7f0e', homePostcode:'RG45BZ' },
    { id:"jason", name:"Jason", color:'#2ca02c', homePostcode:'OX107NP' },
    { id:"phil",  name:"Phil",  color:'#d62728', homePostcode:'HP143TB' },
    { id:"tony",  name:"Tony",  color:'#9467bd', homePostcode:'MK184LQ' },
    { id:"mike",  name:"Mike",  color:'#8c564b', homePostcode:'CM50LL' },
    { id:"andy",  name:"Andy",  color:'#e377c2', homePostcode:'HP143QF' },
    { id:"spare", name:"Spare", color:'#7f7f7f', homePostcode:'OX447RW' },
  ];

  // Status â†’ marker colours
  const statusColours = {
    'Pick up Request': '#de3323',
    'Booking received': '#2e22f4',
    'Driver assigned for delivery': '#ecd0a7',
    'Collected': '#eaa83d',
    'Delivered': '#38651d',
    'Driver assigned for collection': '#ecd0a7'
  };

  // Map
  const map = L.map('map', { zoomSnap:0.5, zoomDelta:0.5 }).setView([52.8,-1.6], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);

  // State
  const JOB_STATUSES = ['Pick up Request','Booking received','Driver assigned for collection','Collected','Driver assigned for delivery','Delivered','Review','Review not requested'];
  const dayInput = document.getElementById('day'); dayInput.valueAsDate = new Date();
  const startInput = document.getElementById('start');
  const statusFilter = document.getElementById('statusFilter');
  const depotPcInput = document.getElementById('depotPc');
  const panel = document.getElementById('panel');

  const jobs = new Map();            // id -> job
  const assignments = {};            // driverId -> [jobIds]
  const depotQueue = [];             // [jobIds]
  const waypointLayers = {};         // driverId -> markerClusterGroup
  const routeCtrls = {};             // driverId -> L.Routing.Control
  const summaries = {};              // driverId -> {distance,duration}
  const osrmRoute = 'https://router.project-osrm.org/route/v1';

  // Per-driver cluster groups + routing controls
  drivers.forEach(d=>{
    assignments[d.id] = [];
    waypointLayers[d.id] = L.markerClusterGroup({
      showCoverageOnHover:false,
      spiderfyOnEveryZoom:true,
      maxClusterRadius:40
    }).addTo(map);

    routeCtrls[d.id] = L.Routing.control({
      router: L.Routing.osrmv1({ serviceUrl: osrmRoute }),
      waypoints: [], addWaypoints:false, routeWhileDragging:false, show:false, draggableWaypoints:false,
      lineOptions:{ styles:[{ color:d.color, weight:3, opacity:0.95 }] }
    }).addTo(map);

    routeCtrls[d.id].on('routesfound', e=>{
      const r = e.routes[0];
      summaries[d.id] = { distance: r.summary.totalDistance, duration: r.summary.totalTime };
      renderPanel();
    });
  });

  // Helpers
  function pin(letter, colour){
    return L.divIcon({ className:'', html:`<div class="mm-pin" style="background:${colour}">${letter}</div>`, iconSize:[20,20], iconAnchor:[10,10] });
  }
  function fmtH(sec){ const h=Math.floor(sec/3600), m=Math.round((sec%3600)/60); return `${h}h ${m}m`; }
  function parseISODate(s){ const d = new Date(s); d.setHours(0,0,0,0); return d; }
  function selectedDay(){ const d = new Date(dayInput.value); d.setHours(0,0,0,0); return d; }
  function isReady(j){ if(!j.ready_date) return true; return parseISODate(j.ready_date).getTime() <= selectedDay().getTime(); }

  // Import JSON
  document.getElementById('importJsonBtn').onclick = async ()=>{
    const text = prompt('Paste jobs JSON: [{"id","title","collection_postcode","delivery_postcode","part_exchange_postcode?","status","plan?","ready_date?"}]');
    if(!text) return;
    try{
      const arr = JSON.parse(text);
      for(const j of arr){ const id=await upsertJob(j); if(!depotQueue.includes(id)) depotQueue.push(id); }
      renderPanel(); drivers.forEach(d=>drawDriver(d.id)); fitAll();
    }catch(err){ alert('Import failed: '+err.message); }
  };

  // Import CSV (button + hidden file input)
  document.getElementById('importCsvBtn').addEventListener('click', ()=>{
    document.getElementById('csvUpload').click();
  });
  document.getElementById('csvUpload').addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    const text = await file.text();
    const lines = text.trim().split(/\r?\n/);
    if (lines.length < 2) { alert('CSV appears empty.'); e.target.value=''; return; }

    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    const get = (row, keys) => {
      for (const k of keys) {
        const i = headers.indexOf(k);
        if (i > -1 && row[i] != null) return row[i].trim();
      }
      return '';
    };

    let imported = 0;
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const row = lines[i].split(',');
      const job = {
        id: get(row, ['id','job_id']) || crypto.randomUUID(),
        title: get(row, ['title','job_title']),
        collection_postcode: get(row, ['collection_postcode','collection','pickup_postcode','pickup']),
        delivery_postcode:   get(row, ['delivery_postcode','delivery','dropoff_postcode','dropoff']),
        part_exchange_postcode: get(row, ['part_exchange_postcode','px_postcode','px']),
        status: get(row, ['status']) || 'Booking received',
        plan: get(row, ['plan']) || 'same_day',
        ready_date: get(row, ['ready_date']) // YYYY-MM-DD
      };
      const id = await upsertJob(job);
      if (!depotQueue.includes(id)) depotQueue.push(id);
      imported++;
    }

    renderPanel(); drivers.forEach(d=>drawDriver(d.id)); fitAll();
    alert(`Imported ${imported} jobs from CSV.`);
    e.target.value = '';
  });

  // Export day
  document.getElementById('exportBtn').onclick = ()=>{
    const fc = { type:'FeatureCollection', features:[], properties:{ date: dayInput.value, start_time: startInput.value, depot: depotPcInput.value } };
    depotQueue.forEach(id=>{ const j=jobs.get(id); if(!j) return; fc.features.push({ type:'Feature', properties:{ kind:'depot_job', id:j.id, title:j.title, status:j.status, ready_date:j.ready_date||'' }, geometry:null }); });
    drivers.forEach(d=>{
      const ids = assignments[d.id]||[];
      const addPt = (lat,lng,props)=> fc.features.push({ type:'Feature', properties:{ driver:d.name, ...props }, geometry:{ type:'Point', coordinates:[lng,lat] }});
      const plan = routeCtrls[d.id].getPlan();
      const wp = plan.getWaypoints().filter(w=>w.latLng).map(w=>[w.latLng.lng, w.latLng.lat]);
      if(wp.length>=2){ fc.features.push({ type:'Feature', properties:{ driver:d.name, kind:'route', distance_m:(summaries[d.id]?.distance)||0, duration_s:(summaries[d.id]?.duration)||0 }, geometry:{ type:'LineString', coordinates: wp } }); }
      ids.forEach((jid, orderIdx)=>{
        const j = jobs.get(jid); if(!j) return;
        if(j.plan==='collect_to_depot'){
          if(j.collection_lat!=null) addPt(j.collection_lat,j.collection_lng,{ kind:'collection', order: orderIdx+1, job_id:j.id, status:j.status, postcode:j.collection_postcode, ready_date:j.ready_date||'' });
        }else if(j.plan==='depot_to_delivery'){
          if(j.delivery_lat!=null) addPt(j.delivery_lat,j.delivery_lng,{ kind:'delivery', order: orderIdx+1, job_id:j.id, status:j.status, postcode:j.delivery_postcode, ready_date:j.ready_date||'' });
          if(j.part_exchange_postcode && j.collection_lat!=null) addPt(j.collection_lat,j.collection_lng,{ kind:'px_return', order: orderIdx+1.1, job_id:j.id, status:j.status, postcode:j.part_exchange_postcode, ready_date:j.ready_date||'' });
        }else{ // same_day
          if(j.collection_lat!=null) addPt(j.collection_lat,j.collection_lng,{ kind:'collection', order: orderIdx+1, job_id:j.id, status:j.status, postcode:j.collection_postcode, ready_date:j.ready_date||'' });
          if(j.delivery_lat!=null) addPt(j.delivery_lat,j.delivery_lng,{ kind:'delivery', order: orderIdx+1.1, job_id:j.id, status:j.status, postcode:j.delivery_postcode, ready_date:j.ready_date||'' });
          if(j.part_exchange_postcode && j.collection_lat!=null) addPt(j.collection_lat,j.collection_lng,{ kind:'px_return', order: orderIdx+1.2, job_id:j.id, status:j.status, postcode:j.part_exchange_postcode, ready_date:j.ready_date||'' });
        }
      });
    });
    const blob = new Blob([JSON.stringify(fc,null,2)], {type:'application/geo+json'});
    saveAs(blob, `move-routes-${dayInput.value}.geojson`);
  };

  // Upsert a job; geocode missing lat/lng; keep ready_date
  async function upsertJob(job){
    const id = job.id || crypto.randomUUID();
    const norm = {
      id,
      title: job.title || `${job.collection_postcode||''} â†’ ${job.delivery_postcode||''}`.trim(),
      collection_postcode: job.collection_postcode || job.postcode || '',
      delivery_postcode: job.delivery_postcode || '',
      part_exchange_postcode: job.part_exchange_postcode || '',
      status: job.status || 'Booking received',
      plan: job.plan || inferPlan(job), // 'collect_to_depot' | 'depot_to_delivery' | 'same_day'
      ready_date: job.ready_date || '',
      collection_lat: job.collection_lat, collection_lng: job.collection_lng,
      delivery_lat: job.delivery_lat, delivery_lng: job.delivery_lng,
      px_lat: job.px_lat, px_lng: job.px_lng
    };
    if(norm.collection_postcode && (norm.collection_lat==null || norm.collection_lng==null)){
      const g = await geocode(norm.collection_postcode); if(g){ norm.collection_lat=g.lat; norm.collection_lng=g.lng; }
    }
    if(norm.delivery_postcode && (norm.delivery_lat==null || norm.delivery_lng==null)){
      const g = await geocode(norm.delivery_postcode); if(g){ norm.delivery_lat=g.lat; norm.delivery_lng=g.lng; }
    }
    if(norm.part_exchange_postcode && (norm.px_lat==null || norm.px_lng==null)){
      const g = await geocode(norm.part_exchange_postcode); if(g){ norm.px_lat=g.lat; norm.px_lng=g.lng; }
    }
    jobs.set(id, norm);
    return id;
  }

  function inferPlan(j){
    const s=(j.status||'').toLowerCase();
    if(s.includes('assigned for collection')||s.includes('pick up')||s.includes('booking')) return 'collect_to_depot';
    if(s.includes('assigned for delivery')) return 'depot_to_delivery';
    return 'same_day';
  }

  async function geocode(pc){
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(pc+', UK')}`;
    const res = await fetch(url, { headers:{'Accept-Language':'en'} });
    const data = await res.json(); if(!data.length) return null; return { lat:+data[0].lat, lng:+data[0].lon };
  }

  function assign(driverId, jobId){ if(!assignments[driverId].includes(jobId)) assignments[driverId].push(jobId); drawDriver(driverId); }
  function unassign(jobId){
    for(const id in assignments){ const i=assignments[id].indexOf(jobId); if(i>-1){ assignments[id].splice(i,1); drawDriver(id);} }
    const d = depotQueue.indexOf(jobId); if(d>-1) depotQueue.splice(d,1);
  }

  // Draw per driver with ready_date filter and clusters
  async function drawDriver(driverId){
    const d = drivers.find(x=>x.id===driverId);
    const layer = waypointLayers[driverId]; layer.clearLayers();

    const todays = (assignments[driverId]||[])
      .map(id=>jobs.get(id))
      .filter(j=>j && (statusFilter.value==='all' || j.status===statusFilter.value))
      .filter(isReady);

    const home = await geocode(d.homePostcode);
    const depot = await geocode(depotPcInput.value || 'OX447RW');

    const waypoints = [];
    function add(lat,lng,label,letter,colour){
      const m = L.marker([lat,lng], { icon: pin(letter, colour) }).bindTooltip(label);
      layer.addLayer(m); waypoints.push(L.latLng(lat,lng));
    }

    if(home) add(home.lat,home.lng, `${d.name} START`, 'H', '#333');

    for(const j of todays){
      const colour = statusColours[j.status] || '#374151';
      if(j.plan==='collect_to_depot'){
        if(j.collection_lat!=null) add(j.collection_lat,j.collection_lng, `Collection â€¢ ${j.collection_postcode}${j.ready_date? ' â€¢ ðŸ“… '+j.ready_date:''}`, 'C', colour);
        if(depot) add(depot.lat,depot.lng, `Depot â€¢ ${depotPcInput.value}`, 'D', '#111');
      }else if(j.plan==='depot_to_delivery'){
        if(depot) add(depot.lat,depot.lng, `Depot â€¢ ${depotPcInput.value}`, 'D', '#111');
        if(j.delivery_lat!=null) add(j.delivery_lat,j.delivery_lng, `Delivery â€¢ ${j.delivery_postcode}${j.ready_date? ' â€¢ ðŸ“… '+j.ready_date:''}`, 'L', colour);
        if(j.part_exchange_postcode && j.collection_lat!=null){ add(j.collection_lat,j.collection_lng, `PX Return â€¢ ${j.part_exchange_postcode}`, 'P', colour); }
      }else{ // same_day
        if(j.collection_lat!=null) add(j.collection_lat,j.collection_lng, `Collection â€¢ ${j.collection_postcode}${j.ready_date? ' â€¢ ðŸ“… '+j.ready_date:''}`, 'C', colour);
        if(j.delivery_lat!=null) add(j.delivery_lat,j.delivery_lng, `Delivery â€¢ ${j.delivery_postcode}`, 'L', colour);
        if(j.part_exchange_postcode && j.collection_lat!=null){ add(j.collection_lat,j.collection_lng, `PX Return â€¢ ${j.part_exchange_postcode}`, 'P', colour); }
      }
    }

    if(home) add(home.lat,home.lng, `${d.name} END`, 'H', '#333');
    routeCtrls[driverId].setWaypoints(waypoints);
  }

  function fitAll(){
    const group = L.featureGroup([]);
    for(const id in waypointLayers){ waypointLayers[id].eachLayer(l=>group.addLayer(l)); }
    if(group.getLayers().length) map.fitBounds(group.getBounds().pad(0.2));
  }

  function renderPanel(){
    const dateStr = new Date(dayInput.value).toDateString();
    const depotList = depotQueue.map(jid=>jobListItem(jid)).join('');
    panel.innerHTML = `<h3>${dateStr}</h3>
      <div class="routeCard" data-depot>
        <header><span>ðŸ›  Oxford Depot</span><span class="lite">${depotPcInput.value}</span></header>
        <ul class="jobs" data-driver="depot">${depotList}</ul>
        <div class="meta">Drag from Depot to a driver to plan delivery legs.</div>
      </div>`
      + drivers.map(d=>{
        const ids = assignments[d.id]||[];
        const list = ids.map(jid=>jobListItem(jid,d.id)).join('');
        const s = summaries[d.id] || {distance:0,duration:0};
        const meta = s.distance? `${(s.distance/1000).toFixed(1)} km Â· ${fmtH(s.duration)}` : 'â€”';
        return `<div class="routeCard" data-driver="${d.id}">
          <header><span><span class="chip dot" style="background:${d.color}"></span>${d.name}</span>
          <span class="meta">${meta}</span></header>
          <ul class="jobs" data-driver="${d.id}">${list}</ul>
          <div class="meta">Start/End: ${d.homePostcode}</div>
        </div>`;
      }).join('');

    // Wire up drag & drop (Depot â‡„ Drivers)
    panel.querySelectorAll('.jobs li[draggable="true"]').forEach(li=>{
      li.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', JSON.stringify({ jobId: li.dataset.id, from: li.dataset.driver })); });
    });
    panel.querySelectorAll('.jobs').forEach(list=>{
      list.addEventListener('dragover', (e)=>{ e.preventDefault(); list.classList.add('dragover'); });
      list.addEventListener('dragleave', ()=> list.classList.remove('dragover'));
      list.addEventListener('drop', (e)=>{
        e.preventDefault(); list.classList.remove('dragover');
        const dropped = JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); if(!dropped.jobId) return;
        const { jobId, from } = dropped;
        if(from==='depot'){ const i=depotQueue.indexOf(jobId); if(i>-1) depotQueue.splice(i,1); }
        else if(from){ const idx = assignments[from].indexOf(jobId); if(idx>-1) assignments[from].splice(idx,1); drawDriver(from); }
        const to = list.dataset.driver;
        if(to==='depot'){ if(!depotQueue.includes(jobId)) depotQueue.push(jobId); }
        else { if(!assignments[to].includes(jobId)) assignments[to].push(jobId); drawDriver(to); }
        renderPanel();
      });
    });

    // Status cycle & plan mode select
    panel.querySelectorAll('button[data-action="status"]').forEach(btn=>{
      btn.onclick = ()=>{ const j = jobs.get(btn.dataset.id); if(!j) return; const i = Math.max(0, JOB_STATUSES.indexOf(j.status)); j.status = JOB_STATUSES[(i+1)%JOB_STATUSES.length]; renderPanel(); drivers.forEach(d=>drawDriver(d.id)); };
    });
    panel.querySelectorAll('select[data-plan]').forEach(sel=>{
      sel.onchange = ()=>{ const j = jobs.get(sel.dataset.id); if(!j) return; j.plan = sel.value; renderPanel(); drivers.forEach(d=>drawDriver(d.id)); };
    });
  }

  function jobListItem(jobId, driverId){
    const j = jobs.get(jobId); if(!j) return '';
    const colour = statusColours[j.status] || '#374151';
    const ready = j.ready_date? `<span class="badge" title="Ready date">ðŸ“… ${j.ready_date}</span>` : '';
    const badge = `<span class="badge" style="background:${colour}; color:#fff; border-color:${colour}">${j.status}</span>`;
    const planSel = `<select data-plan data-id="${j.id}">
      <option value="collect_to_depot" ${j.plan==='collect_to_depot'?'selected':''}>Collection â†’ Depot</option>
      <option value="depot_to_delivery" ${j.plan==='depot_to_delivery'?'selected':''}>Depot â†’ Delivery</option>
      <option value="same_day" ${j.plan==='same_day'?'selected':''}>Same-day C â†’ D</option>
    </select>`;
    return `<li draggable="true" data-id="${j.id}" data-driver="${driverId||'depot'}">
      <div>
        <div><strong>${j.title}</strong> ${ready}</div>
        <div class="lite">C: ${j.collection_postcode||'â€”'} Â· D: ${j.delivery_postcode||'â€”'} ${j.part_exchange_postcode? ' Â· PX: '+j.part_exchange_postcode:''}</div>
      </div>
      <div style="display:flex; gap:6px; align-items:center">${badge}${planSel}<button data-action="status" data-id="${j.id}" title="Cycle status">â†»</button></div>
    </li>`;
  }

  // Hooks
  dayInput.addEventListener('change', ()=>{ drivers.forEach(d=>drawDriver(d.id)); renderPanel(); });
  statusFilter.addEventListener('change', ()=>{ drivers.forEach(d=>drawDriver(d.id)); });
  depotPcInput.addEventListener('change', ()=>{ drivers.forEach(d=>drawDriver(d.id)); });

  // Initial (empty) render
  drivers.forEach(d=>drawDriver(d.id));
  renderPanel();
})();
</script>
</body>
</html>
