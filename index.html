<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Move Motorcycles – Daily Route Planner</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- Export -->
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{ --navy:#040C34; --gold:#A08C59; }
    html,body{height:100%;margin:0} #map{height:100%}

    .toolbar{
      position:fixed;z-index:1000;top:10px;left:50%;transform:translateX(-50%);
      background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.12);
      display:flex;gap:8px;align-items:center;padding:8px 10px;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;flex-wrap:wrap
    }
    .toolbar select,.toolbar button,.toolbar input{height:36px;border-radius:10px;border:1px solid #e5e7eb;padding:0 10px;font-weight:600}
    .toolbar button{background:var(--gold);color:#111;border:none;cursor:pointer}
    .toolbar button.secondary{background:#fff;color:#111;border:1px solid #d1d5db}
    .toolbar .divider{width:1px;height:24px;background:#e5e7eb;margin:0 6px;border-radius:1px}
    .panel{
      position:fixed;right:10px;top:70px;bottom:10px;width:420px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:900;overflow:auto;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif
    }
    .panel h3{margin:14px 14px 6px;font-size:16px;color:var(--navy)}
    .panel .routeCard{margin:10px 12px;padding:10px;border:1px solid #e5e7eb;border-radius:12px}
    .panel .routeCard header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-weight:700;gap:6px}
    .panel .meta{font-size:12px;color:#374151}
    .panel .jobs{list-style:none;margin:8px 0 0;padding:0;min-height:12px}
    .panel .jobs li{display:flex;align-items:center;gap:6px;padding:6px 8px;border:1px dashed #e5e7eb;border-radius:10px;margin-bottom:6px;background:#fafafa;justify-content:space-between}
    .panel .jobs li[draggable="true"]{cursor:grab}
    .panel .jobs li.dragover{outline:2px dashed var(--gold);background:#fff}
    .badge{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb}
    .lite{font-size:12px;color:#6b7280}
    .chip.dot{width:12px;height:12px;border-radius:999px;display:inline-block;vertical-align:middle;margin-right:6px;border:1px solid rgba(0,0,0,.12)}
    .mm-pin{width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;font:bold 11px/1 system-ui;color:#fff}

    /* Fixed diagonal watermark, 0.25 opacity, under vectors */
    .watermark{
      position:fixed;inset:0;pointer-events:none;z-index:200;opacity:.25;
      background-image:repeating-linear-gradient(-30deg,rgba(4,12,52,.08) 0,rgba(4,12,52,.08) 2px,transparent 2px,transparent 140px),
                       repeating-linear-gradient(-30deg,transparent 0,transparent 140px,rgba(4,12,52,.08) 140px,rgba(4,12,52,.08) 142px)
    }
    .watermark::before{
      content:"MOVE MOTORCYCLES MOVE MOTORCYCLES MOVE MOTORCYCLES";
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.4em;font-size:40px;color:#040C34;opacity:.12;transform:rotate(-20deg)
    }

    .leaflet-routing-container{display:none}
    .leaflet-routing-line{stroke:#040C34!important;stroke-width:3px!important}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="watermark" aria-hidden="true"></div>

  <div class="toolbar">
    <label for="day">Date:</label>
    <input id="day" type="date" />
    <div class="divider"></div>

    <label for="start">Start time:</label>
    <input id="start" type="time" value="08:00" />
    <div class="divider"></div>

    <label>Status filter:</label>
    <select id="statusFilter">
      <option value="all">All</option>
      <option>Pick up Request</option>
      <option>Booking received</option>
      <option>Driver assigned for collection</option>
      <option>Collected</option>
      <option>Driver assigned for delivery</option>
      <option>Delivered</option>
      <option>Review</option>
      <option>Review not requested</option>
    </select>

    <div class="divider"></div>
    <label for="depotPc">Depot postcode:</label>
    <input id="depotPc" value="OX447RW" />

    <button id="importBtn" class="secondary">Import jobs JSON</button>
    <button id="exportBtn">Export day (GeoJSON)</button>
  </div>

  <aside class="panel" id="panel"></aside>

<script>
(function(){
  // Drivers (with your home postcodes)
  const drivers = [
    { id:"mark",  name:"Mark",  color:'#1f77b4', homePostcode:'WS137JY' },
    { id:"keith", name:"Keith", color:'#ff7f0e', homePostcode:'RG45BZ' },
    { id:"jason", name:"Jason", color:'#2ca02c', homePostcode:'OX107NP' },
    { id:"phil",  name:"Phil",  color:'#d62728', homePostcode:'HP143TB' },
    { id:"tony",  name:"Tony",  color:'#9467bd', homePostcode:'MK184LQ' },
    { id:"mike",  name:"Mike",  color:'#8c564b', homePostcode:'CM50LL' },
    { id:"andy",  name:"Andy",  color:'#e377c2', homePostcode:'HP143QF' },
    { id:"spare", name:"Spare", color:'#7f7f7f', homePostcode:'OX447RW' },
  ];

  // Status → marker colours
  const statusColours = {
    'Pick up Request': '#de3323',
    'Booking received': '#2e22f4',
    'Driver assigned for delivery': '#ecd0a7',
    'Collected': '#eaa83d',
    'Delivered': '#38651d',
    'Driver assigned for collection': '#ecd0a7'
  };

  // Map
  const map = L.map('map', { zoomSnap:0.5, zoomDelta:0.5 }).setView([52.8,-1.6], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);

  // State
  const JOB_STATUSES = ['Pick up Request','Booking received','Driver assigned for collection','Collected','Driver assigned for delivery','Delivered','Review','Review not requested'];
  const dayInput = document.getElementById('day'); dayInput.valueAsDate = new Date();
  const startInput = document.getElementById('start');
  const statusFilter = document.getElementById('statusFilter');
  const depotPcInput = document.getElementById('depotPc');
  const panel = document.getElementById('panel');

  const jobs = new Map();
  const assignments = {};
  const depotQueue = [];
  const waypointLayers = {};
  const routeCtrls = {};
  const summaries = {};
  const osrmRoute = 'https://router.project-osrm.org/route/v1';

  drivers.forEach(d=>{
    assignments[d.id] = [];
    waypointLayers[d.id] = L.featureGroup().addTo(map);
    routeCtrls[d.id] = L.Routing.control({
      router: L.Routing.osrmv1({ serviceUrl: osrmRoute }),
      waypoints: [], addWaypoints:false, routeWhileDragging:false, show:false, draggableWaypoints:false,
      lineOptions:{ styles:[{ color:d.color, weight:3, opacity:0.95 }] }
    }).addTo(map);

    routeCtrls[d.id].on('routesfound', e=>{
      const route = e.routes[0];
      const legs = route.routes?.[0]?.legs || [];
      let acc=0; const times=[]; legs.forEach(l=>{ acc+=l.duration; times.push(acc); });
      summaries[d.id] = { distance: route.summary.totalDistance, duration: route.summary.totalTime, etas: times };
      renderPanel();
    });
  });

  function pin(letter, colour){
    return L.divIcon({ className:'', html:`<div class="mm-pin" style="background:${colour}">${letter}</div>`, iconSize:[20,20], iconAnchor:[10,10] });
  }

  // Import jobs
  document.getElementById('importBtn').onclick = async ()=>{
    const text = prompt('Paste
